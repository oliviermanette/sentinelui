{% extends 'base.html' %}

{% block title %}Presentation donnée{% endblock %}

{% block body %}
<!-- Begin Page Content -->
<div class="container-fluid">
    <div class="card mb-4 border-bottom-primary">
        <div class="card-header">
            Données brutes - Capteurs Flod
        </div>
        <div class="card-body">
            <div class="container">
                <form name="contact-form" class="ui form" action="" method="post" id="getData">
                    <div class="ui form">
                        <div class="four fields">
                            <div class="field">
                                <div class="text-s font-weight-bold text-primary mb-1">Choisissez un site</div>
                                <select class="browser-default custom-select" name="siteDB" id="siteDB">
                                    <option value="" selected>Choisissez un site</option>

                                    {% for site in all_site %}
                                    <option value={{ site.site_id }}>{{ site.site }} </option>
                                    {% endfor %}

                                </select>
                            </div>
                            <div class="field" id="equipmentField">
                                <div class="text-s font-weight-bold text-primary mb-1">Choisissez un équipement associé
                                </div>
                                <select class="browser-default custom-select" name="equipment" id="equipment">
                                    <option value="" selected>Choisissez un équipement associé</option>
                                    {% for equipment in all_equipment %}
                                    <option value={{ equipment.equipement_id }}>{{ equipment.equipement }} </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field">
                                <div class="text-s font-weight-bold text-primary mb-1">Choisissez une date (optionnel)
                                </div>
                                <input type="text" name="daterange" placeholder="" />
                            </div>
                            <div class="my-2"></div>
                            <button type="submit" id="submit" class="btn btn-info">Montrer les données</button>
                        </div>
                    </div>
                </form>
            </div>
            </br>
            <!-- Page Heading -->



            <div class="container">
                <div class="col">
                    <div class="row-md-2 col-md-offset-4 text-center">
                        <button id="exportData" type="button"
                            class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"
                            onclick="window.open('/ControllerAccueil/downloadRawData?exportData=excel')"><i
                                class="fas fa-download fa-sm text-white-50"></i> Exporter données (Excel)</button>
                        <button id="exportData" type="button"
                            class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"
                            onclick="window.open('/ControllerAccueil/downloadRawData?exportData=csv')"><i
                                class="fas fa-download fa-sm text-white-50"></i> Exporter données (CSV)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </br>


    <!-- Container for displaying the chart data -->
    <div id="chart-display-container" class="container">
    </div>

    <!-- Container for displaying the table data -->
    <div class="container">
        <div id="resultcontainer"></div>
    </div>

     <!-- Container for displaying the chart data -->
    <div id="containerChartsSpectre">
        <div id="chartsSpectreData">
        </div>
    </div>

</div>

{% endblock %}

{% block script %}

<script>
    var dateMax = "";
    var dateMin = "";

    $(document).ready(function () {
        var date = Date();

        $("#siteDB").change(function () {
            var formData = new FormData();
            formData.append('site_id', $(this).children("option:selected").val());
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var response = this.responseText;
                    //console.log(posts);
                    $('#equipmentField').html(response);
                }
            };
            xhttp.open("POST", "/ControllerAccueil/changeEquipement");
            //Send the proper header information along with the request
            xhttp.send(formData);
        });

        $('input[name="daterange"]').daterangepicker({
            showDropdowns: true,
            locale: {
                format: 'DD-MM-YYYY'
            },
            opens: 'left',
            minDate: "{{min_date}}",
            maxDate: "{{max_date}}"
        }, function (start, end, label) {
            dateMin = start.format('YYYY-MM-DD');
            dateMax = end.format('YYYY-MM-DD');
        });
    });

    $("#getData").submit(function (event) {
        event.preventDefault();
        if (!$('#siteDB option:selected').val()) {
            alert("No site is selected");
            return;
        }
        if (!$('#equipment option:selected').val()) {
            alert("No equipement is selected");
            return;
        }
        var drawAll = true;

        var formData = new FormData();
        formData.append('site_request', $('#siteDB option:selected').val());
        formData.append('equipement_request', $('#equipment option:selected').val());
        formData.append('dateMin', dateMin);
        formData.append('dateMax', dateMax);
        formData.append('drawAll', drawAll);
        console.log("Site request : ", $('#siteDB option:selected').val());
        console.log("Equipement request : ", $('#equipment option:selected').val());

        //For displaying the table data
        xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var jsonData = this.responseText;
                $('#resultcontainer').html(jsonData);
                // Call the dataTables jQuery plugin
                $('#tableData').DataTable({
                    "destroy": true, //use for reinitialize datatable
                });
                $('.dataTables_length').addClass('bs-select');

                $('#dataTable').DataTable({
                    'lengthMenu': [
                        [10, 25, 50, -1],
                        [10, 25, 50, 'All']
                    ],
                    'iDisplayLength': 50
                });

            }
        };
        xhttp.open("POST", "/ControllerAccueil/getDataTableAfterSubmit", true);
        xhttp.send(formData);

        //For adding the structure before displaying the chart
        /*
        xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
        if (this.readyState == 4 && this.status == 200) {
        var jsonData = this.responseText;
        //console.log("Refresh data : ",jsonData);
        removeElementAndChilds("chartsSpectreData");
        addElement("containerChartsSpectre", "div", "chartsSpectreData");
        $('#chartsSpectreData').html(jsonData);
        }
        };
        xhttp.open("POST", "/ControllerData/getResultsFromSpectreForm", false);
        xhttp.send(formData);
        */

        xhttp1 = new XMLHttpRequest();
        xhttp1.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var data = this.responseText;
               
                data = JSON.parse(data);

                removeElement("container-chart");

                var temperature_data_json = data['temperature_data'];
                var choc_data_json = data['choc_data'];
                var inclinometre_data_json = data['inclinometre_data'];
                var spectre_data_json = data['spectre_data'];
                var numberOfSpectre = Object.keys(spectre_data_json).length;

                addElement("chart-display-container", "div", "container-chart");
                addElement("container-chart", "div", "row-chart");

                for (i = 0; i < numberOfSpectre; i++) {
                    var name_canva = "canva_" + String(i);
                    addElement("row-chart", "canvas",name_canva);
                }
                for (i = 0; i < numberOfSpectre; i++) {
                    var name_canva = "canva_" + String(i);
                    var name_spectre_data = "spectre_" + String(i);
                    var spectre_i = spectre_data_json[name_spectre_data];
                    //console.log("SPECTRE DATA I : ", spectre_i);
                    drawChartSpectreFromData(spectre_i, name_canva);
                }
                addElement("row-chart", "canvas", "canvas_temperature");
                addElement("row-chart", "canvas", "canvas_inclinometre");
                drawChartTemperatureFromData(temperature_data_json, "canvas_temperature");
                drawChartInclinometerFromData(inclinometre_data_json, "canvas_inclinometre");
            }
        };
        xhttp1.open("POST", "/ControllerAccueil/getAllCharts", true);
        xhttp1.send(formData);
        
    });
</script>

{% endblock %}