{% extends 'base.html' %}

{% block title %}Presentation donnée{% endblock %}

{% block body %}
<!-- Begin Page Content -->
<div class="container-fluid">
    <div class="card mb-4 border-bottom-primary">
        <div class="card-header">
            Données brutes - Capteurs Flod
        </div>
        <div class="card-body">
            <div class="container">
                <form name="contact-form" class="ui form" action="" method="post" id="getData">
                    <div class="ui form d-flex justify-content-center">
                        <div class="row four fields ">
                            <div class="col-sm-6 col-md-4">
                                <div class="mb-2">
                                    <label class="form-label">Choisissez un site</label>
                                    <select class="browser-default custom-select" name="siteSpectre" id="siteSpectre">
                                        <option value="" selected>Choisissez un site</option>

                                        {% for site in all_site %}
                                        <option value={{ site.site_id }}>{{ site.site }} </option>
                                        {% endfor %}

                                    </select>
                                </div>
                            </div>
                            <div class="col-sm-6 col-md-4">
                                <div class="mb-2">
                                    <label class="form-label">Choisissez un équipement</label>
                                    <select class="browser-default custom-select" name="equipmentField"
                                        id="equipmentField">
                                        <option value="" selected>Choisissez un équipement associé</option>
                                        {% for equipment in all_equipment %}
                                        <option value={{ equipment.equipement_id }}>{{ equipment.equipement }} </option>
                                        {% endfor %}
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-2">
                                    <label class="form-label">Choisissez une date (optionnel)</label>
                                    <div id="reportrange" class="browser-default custom-select">
                                        <i class="glyphicon glyphicon-calendar fa fa-calendar"></i>
                                        <span></span>
                                        <!-- <span>December 30, 2014 - January 28, 2015</span>-->
                                    </div>
                                </div>
                            </div>
                            <div class="container">
                                <div class="row">
                                    <div class="col text-center">
                                        <button type="submit" id="submit" class="btn btn-info">Montrer les
                                            spectres</button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </form>
            </div>
            </br>
            <!-- Page Heading -->



            <div class="container">
                <div class="col">
                    <div class="row-md-2 col-md-offset-4 text-center">
                        <button id="exportData" type="button"
                            class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"
                            onclick="window.open('/ControllerData/downloadRawData?exportData=excel')"><i
                                class="fas fa-download fa-sm text-white-50"></i> Exporter données (Excel)</button>
                        <button id="exportData" type="button"
                            class="d-none d-sm-inline-block btn btn-sm btn-primary shadow-sm"
                            onclick="window.open('/ControllerData/downloadRawData?exportData=csv')"><i
                                class="fas fa-download fa-sm text-white-50"></i> Exporter données (CSV)</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    </br>

    <!-- Container for displaying the chart data -->
    <div id="chart-display-container" class="container">
    </div>

    <!-- Container for displaying the table data -->
    <div class="container">
        <div id="resultcontainer"></div>
    </div>

    <!-- Container for displaying the chart data -->
    <div id="containerChartsSpectre">
        <div id="chartsSpectreData">
        </div>
    </div>

</div>

{% endblock %}

{% block script %}

<script>
    var startDate = "";
    var endDate = "";
    let diffDays = "";

    $(document).ready(function () {
        init_daterangepicker();
        var date = Date();

        $("#siteSpectre").change(function () {
            var formData = new FormData();
            formData.append('site_id', $(this).children("option:selected").val());
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var response = this.responseText;
                    //console.log(posts);
                    $('#equipmentField').html(response);
                }
            };
            xhttp.open("POST", "/ControllerData/changeEquipement");
            //Send the proper header information along with the request
            xhttp.send(formData);
        });

    });

    $("#getData").submit(function (event) {
        event.preventDefault();
        if (!$('#siteSpectre option:selected').val()) {
            alert("Selectionnez un site");
            return;
        }
        if (!$('#equipmentField option:selected').val()) {
            alert("Selectionner un équippement");
            return;
        }

        var formData = new FormData();
        formData.append('site_request', $('#siteSpectre option:selected').val());
        formData.append('equipement_request', $('#equipmentField option:selected').val());
        formData.append('startDate', startDate);
        formData.append('endDate', endDate);
        console.log("Site request : ", $('#siteSpectre option:selected').val());
        console.log("Equipement request : ", $('#equipmentField option:selected').val());
        console.log("Start date: ", startDate);
        console.log("endDate date: ", endDate);

        //For displaying the table data
        xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var jsonData = this.responseText;
                $('#resultcontainer').html(jsonData);
                // Call the dataTables jQuery plugin
                $('#tableData').DataTable({
                    "destroy": true, //use for reinitialize datatable
                    responsive: true,
                    responsive: {
                        details: {
                            type: 'column',
                            target: 'tr'
                        }
                    },
                    orderCellsTop: true,
                    fixedHeader: true,
                });
                $('.dataTables_length').addClass('bs-select');

                $('#dataTable').DataTable({
                    'lengthMenu': [
                        [10, 25, 50, -1],
                        [10, 25, 50, 'All']
                    ],
                    'iDisplayLength': 50
                });

            }
        };
        xhttp.open("POST", "/ControllerAccueil/getDataTableAfterSubmit", true);
        xhttp.send(formData);

        xhttp1 = new XMLHttpRequest();
        xhttp1.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var data = this.responseText;
                data = JSON.parse(data);
                console.log("Data spectre : ", data);
                removeElement("container-chart");

                var spectre_data_json = data['spectre_data'];
                var site_id = data['site_id'];
                var equipement_id = data['equipment_id'];
                var numberOfSpectre = Object.keys(spectre_data_json).length;

                addElement("chart-display-container", "div", "container-chart");
                addElement("container-chart", "div", "row-chart");

                for (i = 0; i < numberOfSpectre; i++) {
                    var name_canva = "canva_" + String(i);
                    addElement("row-chart", "canvas", name_canva);
                    var name_spectre_data = "spectre_" + String(i);
                    var date_subspectre0 = spectre_data_json[name_spectre_data][0]["date"];
                    var link =
                        "/ControllerData/downloadSpectre?siteID=" + site_id + "&equipementID=" + equipement_id + "&requestedDate=" + date_subspectre0;
                    addButton("row-chart", "Telecharger le spectre", link);
                }
                for (i = 0; i < numberOfSpectre; i++) {
                    var name_canva = "canva_" + String(i);
                    var name_spectre_data = "spectre_" + String(i);
                    var spectre_i = spectre_data_json[name_spectre_data];
                    //console.log("SPECTRE DATA I : ", spectre_i);
                    drawChartSpectreFromData(spectre_i, name_canva);
                }

            }
        };
        xhttp1.open("POST", "/ControllerAccueil/getAllCharts", true);
        xhttp1.send(formData);

    });

    function init_daterangepicker() {
        moment.locale('fr');
        if (typeof ($.fn.daterangepicker) === 'undefined') {
            return;
        }

        var cb = function (start, end, label) {
            //console.log(start.toISOString(), end.toISOString(), label);
            $('#reportrange span').html(start.format('L') + ' - ' + end.format('L'));
        };

        var optionSet = {
            minDate: '09/01/2019',
            maxDate: moment(),
            showDropdowns: true,
            showWeekNumbers: true,
            timePicker: false,
            timePickerIncrement: 1,
            timePicker12Hour: true,
            ranges: {
                'Aucune Date': ['09/01/2019', moment()],
                'Hier': [moment().subtract(1, 'days'), moment().subtract(1, 'days')],
                'Dernier 7 jours': [moment().subtract(6, 'days'), moment()],
                'Dernier 30 Jours': [moment().subtract(29, 'days'), moment()],
                'Ce mois': [moment().startOf('month'), moment().endOf('month')]
            },
            opens: 'left',
            buttonClasses: ['btn btn-default'],
            applyClass: 'btn-small btn-primary',
            cancelClass: 'btn-small',
            format: 'DD/MM/YYYY',
            separator: ' à ',
            locale: {
                applyLabel: 'Appliquer',
                cancelLabel: 'Annuler',
                fromLabel: 'De',
                toLabel: 'à',
                customRangeLabel: 'Specifique',
                daysOfWeek: ['Di', 'Lu', 'Ma', 'Me', 'Je', 'Ve', 'Sa'],
                monthNames: ['Janvier', 'Février', 'Mars', 'Avril', 'Mai', 'juin', 'Juillet', 'Août',
                    'Septembre', 'Octobre', 'Novembre', 'Décembre'
                ],
                firstDay: 1
            }
        }

        $('#reportrange').daterangepicker(optionSet, cb);

        $('#reportrange').on('apply.daterangepicker', function (ev, picker) {
            startDate = picker.startDate.format('YYYY-MM-DD');
            endDate = picker.endDate.format('YYYY-MM-DD');;
            let diffDays = picker.endDate.diff(picker.startDate, 'days');
            console.log("start/end dates are " + startDate + " to " + endDate);

            console.log(`Difference in days: ${diffDays}`);
        });
        $('#reportrange').on('cancel.daterangepicker', function (ev, picker) {
            startDate = '';
            endDate = '';
            $('#reportrange span').html(startDate + ' - ' + endDate);
        });

    };
</script>

{% endblock %}