{% extends 'base.html' %}

{% block title %}Chocs données{% endblock %}

{% block body %}

<div class="container-fluid">
    <div class="card mb-4 border-bottom-primary">
        <div class="card-header">
            Chocs
        </div>
        <div class="card-body">
            <div class="container">
                <form role="form" method="post" name="equipementrequest" id="equipementrequest">
                    <div class="ui form">
                        <div class="four fields">
                            <div class="field">
                                <div class="text-s font-weight-bold text-primary mb-1">Choisissez un site</div>
                                <select class="browser-default custom-select" name="siteID" id="siteID">
                                    <option value="" selected>Choisissez un site</option>
                                    {% for site in all_site %}
                                    <option value={{ site.site_id }}>{{ site.site }} </option>
                                    {% endfor %}

                                </select>
                            </div>
                            <div class="field" id="equipmentField">
                                <div class="text-s font-weight-bold text-primary mb-1">Choisissez un équipement
                                    associé
                                </div>
                                <select class="browser-default custom-select" name="equipment" id="equipment">
                                    <option value="" selected>Choisissez un équipement associé</option>
                                    {% for equipment in all_equipment %}
                                    <option value={{ equipment.equipement_id }}>{{ equipment.equipement }}
                                    </option>
                                    {% endfor %}
                                </select>
                            </div>
                            <div class="field">
                                <div class="text-s font-weight-bold text-primary mb-1">Choisissez une date
                                    (optionnel)
                                </div>
                                <input type="text" name="daterange" placeholder="" />
                            </div>
                            <div class="my-2"></div>
                            <button type="submit" id="submit" class="btn btn-info">Montrer les données</button>
                        </div>
                    </div>
                </form>
            </div>
            </br>
            <!-- Page Heading -->

        </div>
    </div>

    <div id="containerTab">
        <div id="resultcontainer">

        </div>
    </div>
</div>

{% endblock %}

{% block script %}

<script>
    var dateMax = "";
    var dateMin = "";
    //When the user want to change the date for displaying the chart concerning the number of choc
    // per day
    // Day, week or month
    $(document).on("click", "#radioButtonNbChoc", function (e) {
        e.preventDefault();

        var equipementID = $(this).parent('div').attr('id');
        var radioValueTime = $("input[name='options']:checked").val();
        var formData = new FormData();
        formData.append('time_data', radioValueTime);
        formData.append('equipementID', equipementID);

        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var response = this.responseText;
                var nameCanvas = "canvas_equipement_" + equipementID;
                var nameChartAreaCanvas = "chart_area_id_" + equipementID;
                removeElement(nameCanvas);
                addElement(nameChartAreaCanvas, "canvas", nameCanvas);
                drawChartNbChocDate(response, nameCanvas);

            }
        };
        xhttp.open("POST", "/ControllerData/getChartChocFrequencies");
        xhttp.send(formData);
    });

    //When the user want to change the date for displaying the chart concerning the power of choc
    // Day, week or month
    $(document).on("click", "#radioButtonPowerChoc", function (e) {
        e.preventDefault();

        var equipementID = $(this).parent('div').attr('id');
        var radioValueTime = $("input[name='options']:checked").val();

        var formData = new FormData();
        formData.append('time_data', radioValueTime);
        formData.append('equipementID', equipementID);
        var xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var response = this.responseText;
                var nameCanvas = "canvas_equipement_bis_" + equipementID;
                var nameChartAreaCanvas = "chart_area_bis_id_" + equipementID;
                removeElement(nameCanvas);
                addElement(nameChartAreaCanvas, "canvas", nameCanvas);
                drawPowerChocPerDateBar(response, nameCanvas);
            }
        };
        xhttp.open("POST", "/ControllerData/getChartPowerChocFrequencies");
        xhttp.send(formData);
    });


    $(document).ready(function () {
        var date = Date();
        // When the user select a site, the equipement associated is displayed
        $("#siteDB").change(function () {
            var formData = new FormData();
            formData.append('site_id', $(this).children("option:selected").val());
            var xhttp = new XMLHttpRequest();
            xhttp.onreadystatechange = function () {
                if (this.readyState == 4 && this.status == 200) {
                    var response = this.responseText;
                    //console.log(posts);
                    $('#equipmentField').html(response);
                }
            };
            xhttp.open("POST", "/ControllerAccueil/changeEquipement");
            //Send the proper header information along with the request
            xhttp.send(formData);
        });

        $('input[name="daterange"]').daterangepicker({
            showDropdowns: true,
            locale: {
                format: 'DD-MM-YYYY'
            },
            opens: 'left',
            minDate: "{{min_date}}",
            maxDate: "{{max_date}}"
        }, function (start, end, label) {
            dateMin = start.format('YYYY-MM-DD');
            dateMax = end.format('YYYY-MM-DD');
        });

    });

    //When the user want to retrieve the data after submitting the form
    $(document).on('submit', '#equipementrequest', function (event) {
        event.preventDefault();

        if (!$('#siteID option:selected').val()) {
            alert("No site is selected");
            return;
        }


        var formData = new FormData();
        formData.append('siteID', $('#siteID option:selected').val());

        xhttp = new XMLHttpRequest();
        xhttp.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var jsonData = this.responseText;
                //console.log("Refresh data : ",jsonData);
                removeElementAndChilds("resultcontainer");
                addElement("containerTab", "div", "resultcontainer");
                $('#resultcontainer').html(jsonData);
            }
        };
        xhttp.open("POST", "/ControllerData/refreshData", true);
        xhttp.send(formData);


        xhttp1 = new XMLHttpRequest();
        xhttp1.onreadystatechange = function () {
            if (this.readyState == 4 && this.status == 200) {
                var choc_data = this.responseText;
                choc_data = JSON.parse(choc_data);
                //console.log(choc_data);
                for (var i = 0; i < Object.keys(choc_data).length; i++) {
                    var name_data = "equipement_" + i;
                    var name_canvas = "canvas_equipement_" + choc_data[name_data]['equipementId'];
                    var name_canvas_bis = "canvas_equipement_bis_" + choc_data[name_data]['equipementId'];
                    drawChartNbChocDate(choc_data[name_data]['nb_choc_per_day'], name_canvas);
                    drawPowerChocPerDateBar(choc_data[name_data]['power_choc_per_day'], name_canvas_bis);
                }
            }
        };
        xhttp1.open("POST", "/ControllerData/getChartsChoc", true);
        xhttp1.send(formData);
    });
</script>

{% endblock %}